{% extends 'header_base.html' %}
{% load static %}
{% block title %}Send Email{% endblock %}

{% block content %}
<style>
    /* home.css */

    /* Overall container */
    .email-container {
        display: flex;
        margin: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f8f8f8;
    }

    /* Container for form elements */
    .form-section {
        flex: 1;
        margin-right: 20px;
    }

    /* Style for labels */
    label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
    }

    /* Style for inputs */
    input[type="text"], input[type="email"] {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* Style for select dropdown */
    select {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    /* Style for the email template preview section */
    #template-preview {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #fff;
    }

    /* Container for dynamic fields and template options header */
    #dynamic-fields-container {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    /* Header for the dynamic fields container */
    .dynamic-fields-header {
        font-size: 1.2em;
        margin-bottom: 10px;
        font-weight: bold;
    }

    /* Container for the dynamic input fields */
    .dynamic-fields-content {
        flex: 1; /* This makes it take up the remaining space */
    }

    /* Style for buttons */
    button {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }
</style>
<div class="email-container">
    <!-- Container for existing form elements and dynamic fields -->
    <div style="display: flex; width: 100%;">
        <!-- Left side container for existing form elements -->
        <div class="form-section">
            <h2>Email Templator</h2>

            <label for="email-template">Select Template:</label>
            <select id="email-template" onchange="updateTemplateAndSubject()">
                <option value="1" selected>Email Template 1</option>
                <option value="2">Email Template 2</option>
            </select>

            <div style="margin-top: 10px;">
                <label for="email-subject">Email Subject:</label>
                <input type="text" id="email-subject" value="Escalation Email">
            </div>

            <div style="margin-top: 10px;">
                <label for="email-to">To:</label>
                <input type="email" id="email-to" value="patelv2895@gmail.com" placeholder="Recipient's email">
            </div>

            <div style="margin-top: 10px;">
                <label for="email-from">From:</label>
                <input type="email" id="email-from" value="patelv2895@gmail.com" placeholder="Your email">
            </div>

            <div style="margin-top: 10px;">
                <label for="email-cc">CC:</label>
                <input type="email" id="email-cc" placeholder="CC email">
            </div>

            <div id="template-preview" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;">
                <!-- Email template content -->
            </div>

            {% csrf_token %}
            <button onclick="sendEmail()">Send Email</button>
        </div>

        <!-- Right side container for dynamic fields -->
        <div id="dynamic-fields-container">
            <div class="dynamic-fields-header">Template Options</div>
            <div class="dynamic-fields-content">
                <!-- Dynamic fields will be added here -->
            </div>
        </div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function updateTemplateAndSubject() {
        var templateId = document.getElementById("email-template").value;
        var subject = templateId === "1" ? "Subject 1" : "Subject 2";
        document.getElementById("email-subject").value = subject;

        fetch(`/get_template_content/${templateId}`)
            .then(response => response.json())
            .then(data => {
                if (data.content) {
                    document.getElementById("template-preview").innerHTML = data.content;
                    generateInputFields(data.content);
                } else {
                    alert('Template not found');
                }
            })
            .catch(error => {
                alert('Error fetching template: ' + error);
            });
    }

    function generateInputFields(templateContent) {
        // Example regex to find placeholders like {{name}}
        const placeholderRegex = /\{\{(\w+)\}\}/g;
        let match;
        let inputFieldsContainer = document.getElementById('dynamic-fields-container'); // Corrected the ID here
        inputFieldsContainer.innerHTML = ''; // Clear previous fields

        while ((match = placeholderRegex.exec(templateContent)) !== null) {
            let inputField = createInputField(match[1]);
            inputFieldsContainer.appendChild(inputField);
        }
    }

    function createInputField(fieldName) {
        let container = document.createElement('div');
        let label = document.createElement('label');
        label.innerHTML = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
        let input = document.createElement('input');
        input.type = 'text';
        input.id = fieldName;
        input.name = fieldName;

        container.appendChild(label);
        container.appendChild(input);

        return container;
    }

    function sendEmail() {
        var templateId = document.getElementById("email-template").value;
        var subject = document.getElementById("email-subject").value;
        var toEmail = document.getElementById("email-to").value;
        var fromEmail = document.getElementById("email-from").value;
        var ccEmail = document.getElementById("email-cc").value;
        var templateContent = document.getElementById("template-preview").innerHTML;

        $.ajax({
            url: '/send_email/',
            type: 'post',
            headers: {'X-CSRFToken': getCSRF('csrftoken')},
            data: JSON.stringify({
                'subject': subject,
                'template_id': templateId,
                'template_content': templateContent,
                'to_email': toEmail,
                'from_email': fromEmail,
                'cc_email': ccEmail,
                'dynamic_fields': getDynamicFieldValues()
            }),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(data) {
                alert(data.message);
            },
            error: function(xhr, errmsg, err) {
                alert('Failed to send email: ' + xhr.status + ": " + xhr.responseText);
            }
        });
    }

    function getCSRF(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    document.addEventListener('DOMContentLoaded', function() {
        updateTemplateAndSubject();
    }, false);
</script>
{% endblock %}