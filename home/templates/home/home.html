{% extends 'header_base.html' %}
{% load static %}
{% block title %}Send Email{% endblock %}

{% block content %}
<style>
    /* home.css */
    .email-container {
        display: flex;
        margin: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f8f8f8;
    }

    .section-header {
        font-size: 1.2em;
        margin-bottom: 10px;
        font-weight: bold;
    }

    .form-section, .dynamic-fields-content {
        flex: 1;
        margin-right: 20px;
        display: flex;
        flex-direction: column;
    }

    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    label {
        font-weight: bold;
        margin-right: 10px;
    }

    input[type="text"], input[type="email"], select {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
    }

    #template-preview {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #fff;
    }

    button {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }
</style>
<div class="email-container">
    <div class="form-section">
        <div class="section-header">Email Templator</div>

        <div class="form-group">
            <label for="email-template">Select Template:</label>
            <select id="email-template" onchange="updateTemplateAndSubject()">
                <option value="1" selected>Email Template 1</option>
                <option value="2">Email Template 2</option>
            </select>
        </div>

        <div class="form-group">
            <label for="email-subject">Email Subject:</label>
            <input type="text" id="email-subject" value="Escalation Email">
        </div>

        <div class="form-group">
            <label for="email-to">To:</label>
            <input type="email" id="email-to" value="patelv2895@gmail.com" placeholder="Recipient's email">
        </div>

        <div class="form-group">
            <label for="email-from">From:</label>
            <input type="email" id="email-from" value="patelv2895@gmail.com" placeholder="Your email">
        </div>

        <div class="form-group">
            <label for="email-cc">CC:</label>
            <input type="email" id="email-cc" placeholder="CC email">
        </div>

        <div id="template-preview" contenteditable="true"></div>

        {% csrf_token %}
        <button onclick="sendEmail()">Send Email</button>
    </div>

</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function updateTemplateAndSubject() {
        var templateId = document.getElementById("email-template").value;
        var subject = templateId === "1" ? "Subject 1" : "Subject 2";
        document.getElementById("email-subject").value = subject;

        fetch(`/get_template_content/${templateId}`)
            .then(response => response.json())
            .then(data => {
                if (data.content) {
                    document.getElementById("template-preview").innerHTML = data.content;
                    generateInputFields(data.content);
                } else {
                    alert('Template not found');
                }
            })
            .catch(error => {
                alert('Error fetching template: ' + error);
            });
    }




    function sendEmail() {
        console.log("sendEmail function called");
        var templateId = document.getElementById("email-template").value;
        var subject = document.getElementById("email-subject").value;
        var toEmail = document.getElementById("email-to").value;
        var fromEmail = document.getElementById("email-from").value;
        var ccEmail = document.getElementById("email-cc").value;
        var templateContent = document.getElementById("template-preview").innerHTML;

        console.log("Data being sent:", { subject, templateId, templateContent, toEmail, fromEmail, ccEmail });
        $.ajax({
            url: '/send_email/',
            type: 'post',
            headers: {'X-CSRFToken': getCSRF('csrftoken')},
            data: JSON.stringify({
                'subject': subject,
                'template_id': templateId,
                'template_content': templateContent,
                'to_email': toEmail,
                'from_email': fromEmail,
                'cc_email': ccEmail,
                'dynamic_fields': getDynamicFieldValues()
            }),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(data) {
                console.log("Email sent successfully", data);
                alert(data.message);
            },
            error: function(xhr, errmsg, err) {
                console.log("Email not sent", data);
                alert('Failed to send email: ' + xhr.status + ": " + xhr.responseText);
            }
        });
    }


    function updatePreview() {
        const dynamicFields = getDynamicFieldValues();
        let templateContent = `
            <table style="width: 100%; border-collapse: collapse;">
                <colgroup>
                    <col style="width: 30%;"> <!-- Adjust the percentage as needed -->
                    <col style="width: 70%;"> <!-- This will take the remaining width -->
                </colgroup>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Ticket Number:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Ticket_Number || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Contact Name:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Contact_Name || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Contact Number:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Contact_Number || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Contact Location:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Contact_Location || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Contact working hours:</td>
                    <td style="border: 1px solid black; padding: 5px;">N/A</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Alternate Contact Number:</td>
                    <td style="border: 1px solid black; padding: 5px;">N/A</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Application Affected:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Application_Affected || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Description of Problem:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Description_Of_Problem || ''}</td>
                </tr>
            </table>
        `;

        document.getElementById('template-preview').innerHTML = templateContent;
    }


    function getCSRF(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    document.addEventListener('DOMContentLoaded', function() {
        updateTemplateAndSubject();
        updatePreview();
    }, false);
</script>
{% endblock %}