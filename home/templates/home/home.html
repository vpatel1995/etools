{% extends 'header_base.html' %}
{% load static %}
{% block title %}Send Email{% endblock %}

{% block content %}
<style>
    /* home.css */
    .email-container {
        display: flex;
        margin: 20px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background-color: #f8f8f8;
    }

    .section-header {
        font-size: 1.2em;
        margin-bottom: 10px;
        font-weight: bold;
    }

    .form-section, .dynamic-fields-content {
        flex: 1;
        margin-right: 20px;
        display: flex;
        flex-direction: column;
    }

    input[type="text"], input[type="email"], select {
        flex-grow: 1;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        max-width: 400px; /* Adjust this value as needed */
    }

    .form-group {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        flex-wrap: wrap; /* Ensures that elements wrap in smaller screens */
    }

    label {
        font-weight: bold;
        margin-right: 10px;
        white-space: nowrap; /* Prevents the label from wrapping */
    }

    #template-preview {
        margin-top: 20px;
        padding: 10px;
        border: 1px solid #ccc;
        background-color: #fff;
    }

    button {
        padding: 10px 15px;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }

    .small-container {
        max-width: 300px; /* Adjust the width as needed */
    }
</style>
<div class="email-container">
    <div class="form-section">
        <div class="section-header">Email Templator</div>

        <!-- Checkbox for toggling visibility of additional options -->
        <div class="form-group toggle-options">
            <input type="checkbox" id="hide-options" name="hide-options" checked>
            <label for="hide-options">Hide Options</label>
        </div>

        <div class="form-group select-template">
            <label for="email-template">Select Template:</label>
            <select id="email-template" onchange="updateTemplateAndSubject()">
                <option value="1" selected>Email Template 1</option>
                <option value="2">Email Template 2</option>
            </select>
        </div>

        <div class="form-group">
            <label for="email-subject">Email Subject:</label>
            <input type="text" id="email-subject" value="Escalation Email">
        </div>

        <div class="form-group">
            <label for="email-to">To:</label>
            <input type="email" id="email-to" value="patelv2895@gmail.com" placeholder="Recipient's email">
        </div>

        <div class="form-group">
            <label for="email-from">From:</label>
            <input type="email" id="email-from" value="patelv2895@gmail.com" placeholder="Your email">
        </div>

        <div class="form-group">
            <label for="email-cc">CC:</label>
            <input type="email" id="email-cc" placeholder="CC email">
        </div>

        <div id="template-preview" contenteditable="true"></div>

        {% csrf_token %}
        <button onclick="sendEmail()">Send Email</button>
    </div>

    <div id="dynamic-fields-container">
        <div class="dynamic-fields-content"></div>
    </div>
</div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    function updateTemplateAndSubject() {
        var templateId = document.getElementById("email-template").value;
        var subject = templateId === "1" ? "Subject 1" : "Subject 2";
        document.getElementById("email-subject").value = subject;

        fetch(`/get_template_content/${templateId}`)
            .then(response => response.json())
            .then(data => {
                if (data.content) {
                    // Replace placeholders with empty strings or default values
                    let templateContent = data.content.replace(/\{\{(\w+)\}\}/g, function(match, p1){
                        return ''; // Replace with default value if needed, else just an empty string
                    });
                    document.getElementById("template-preview").innerHTML = templateContent;
                    generateInputFields(data.content);
                } else {
                    alert('Template not found');
                }
            })
            .catch(error => {
                alert('Error fetching template: ' + error);
            });
    }

    function generateInputFields(templateContent) {
        // Example regex to find placeholders like {{name}}
        const placeholderRegex = /\{\{(\w+)\}\}/g;
        let match;
        let dynamicFieldsContent = document.querySelector('.dynamic-fields-content'); // Target the .dynamic-fields-content div
        dynamicFieldsContent.innerHTML = ''; // Clear previous fields

        while ((match = placeholderRegex.exec(templateContent)) !== null) {
            let inputField = createInputField(match[1]);
            dynamicFieldsContent.appendChild(inputField); // Append to .dynamic-fields-content
        }
    }

    function createInputField(fieldName) {
        let container = document.createElement('div');
        let label = document.createElement('label');
        label.innerHTML = fieldName.charAt(0).toUpperCase() + fieldName.slice(1);
        let input = document.createElement('input');
        input.type = 'text';
        input.id = fieldName;
        input.name = fieldName;

        // Attach event listener to dynamically created input field
        input.addEventListener('input', updatePreview);

        container.appendChild(label);
        container.appendChild(input);

        return container;
    }

    function sendEmail() {
        console.log("sendEmail function called");
        var templateId = document.getElementById("email-template").value;
        var subject = document.getElementById("email-subject").value;
        var toEmail = document.getElementById("email-to").value;
        var fromEmail = document.getElementById("email-from").value;
        var ccEmail = document.getElementById("email-cc").value;
        var templateContent = document.getElementById("template-preview").innerHTML;

        console.log("Data being sent:", { subject, templateId, templateContent, toEmail, fromEmail, ccEmail });
        $.ajax({
            url: '/send_email/',
            type: 'post',
            headers: {'X-CSRFToken': getCSRF('csrftoken')},
            data: JSON.stringify({
                'subject': subject,
                'template_id': templateId,
                'template_content': templateContent,
                'to_email': toEmail,
                'from_email': fromEmail,
                'cc_email': ccEmail,
                'dynamic_fields': getDynamicFieldValues()
            }),
            contentType: "application/json; charset=utf-8",
            dataType: 'json',
            success: function(data) {
                console.log("Email sent successfully", data);
                alert(data.message);
            },
            error: function(xhr, errmsg, err) {
                console.log("Email not sent", data);
                alert('Failed to send email: ' + xhr.status + ": " + xhr.responseText);
            }
        });
    }

    function getDynamicFieldValues() {
        var dynamicFields = document.querySelectorAll('.dynamic-fields-content input[type="text"]');
        var fieldValues = {};

        dynamicFields.forEach(function(field) {
            fieldValues[field.id] = field.value;
        });

        return fieldValues;
    }

    function updatePreview() {
        const dynamicFields = getDynamicFieldValues();
        let templateContent = `
            <table style="width: 100%; border-collapse: collapse;">
                <colgroup>
                    <col style="width: 30%;"> <!-- Adjust the percentage as needed -->
                    <col style="width: 70%;"> <!-- This will take the remaining width -->
                </colgroup>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Ticket Number:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Ticket_Number || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Contact Name:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Contact_Name || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Contact Number:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Contact_Number || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Contact Location:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Contact_Location || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Contact working hours:</td>
                    <td style="border: 1px solid black; padding: 5px;">N/A</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Alternate Contact Number:</td>
                    <td style="border: 1px solid black; padding: 5px;">N/A</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Application Affected:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Application_Affected || ''}</td>
                </tr>
                <tr>
                    <td style="border: 1px solid black; padding: 5px;">Description of Problem:</td>
                    <td style="border: 1px solid black; padding: 5px;">${dynamicFields.Description_Of_Problem || ''}</td>
                </tr>
            </table>
        `;

        document.getElementById('template-preview').innerHTML = templateContent;
    }

    // Function to toggle form visibility
    function toggleFormVisibility() {
        var isHidden = document.getElementById('hide-options').checked;
        var emailContainer = document.querySelector('.email-container');
        var formElements = document.querySelectorAll('.form-group, #template-preview, #dynamic-fields-container');

        // Apply the smaller width when checkbox is checked
        if (isHidden) {
            emailContainer.classList.add('small-container');
        } else {
            emailContainer.classList.remove('small-container');
        }

        formElements.forEach(el => {
            if (!el.classList.contains('toggle-options') && !el.classList.contains('select-template')) {
                el.style.display = isHidden ? 'none' : 'flex';
            }
        });

        // Always show the select template and send email button
        document.querySelector('.form-section > .form-group.select-template').style.display = 'flex';
        document.querySelector('.form-section > button').style.display = 'flex';
    }

    // Make sure to call this function to apply initial state
    toggleFormVisibility();

    // Event listener for checkbox
    document.getElementById('hide-options').addEventListener('change', toggleFormVisibility);


    function getCSRF(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = jQuery.trim(cookies[i]);
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    document.addEventListener('DOMContentLoaded', function() {
        updateTemplateAndSubject();
        updatePreview();
        toggleFormVisibility();
    }, false);
</script>
{% endblock %}